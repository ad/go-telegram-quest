# Telegram Quest Bot

Telegram-бот для проведения линейных квестов с полной персистентностью состояния. Бот не теряет прогресс пользователей при рестарте, администратор может управлять шагами квеста во время прохождения.

## Возможности

### Для участников
- Линейное прохождение квеста с автоматическим переходом между шагами
- Текстовые задания с автопроверкой ответов (case-insensitive)
- Задания с изображениями
- Ответы текстом или фотографиями
- Сохранение прогресса — можно продолжить с того же места после перезапуска бота
- Статистика: процент участников, дошедших до текущего шага

### Для администратора
- Telegram-интерфейс для управления квестом (`/admin`)
- Добавление, редактирование и удаление шагов
- Настройка вариантов правильных ответов для автопроверки
- Ручная проверка ответов-изображений с inline-кнопками
- Soft-disable шагов (временное отключение без удаления)
- Редактирование системных сообщений (приветствие, финал, правильный/неправильный ответ)
- Автообновляемая статистика прохождения
- Уведомления о завершении квеста участниками
- Уведомления об ошибках с полным стектрейсом

## Архитектура

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│   Telegram  │────▶│     Bot     │────▶│   State     │
│     API     │◀────│   Handler   │◀────│  Resolver   │
└─────────────┘     └─────────────┘     └─────────────┘
                           │                   │
                           ▼                   ▼
                    ┌─────────────┐     ┌─────────────┐
                    │   Message   │     │   Answer    │
                    │   Manager   │     │   Checker   │
                    └─────────────┘     └─────────────┘
                           │                   │
                           └─────────┬─────────┘
                                     ▼
                           ┌─────────────────┐
                           │    DB Queue     │
                           │ (single-writer) │
                           └─────────────────┘
                                     │
                                     ▼
                           ┌─────────────────┐
                           │     SQLite      │
                           └─────────────────┘
```

### Ключевые решения

- **SQLite как единственный источник истины** — всё состояние хранится в БД, FSM восстанавливается на каждый update
- **Single-writer DB Queue** — все операции с БД через единственный goroutine с retry (3 попытки)
- **Panic recovery** — все обработчики обёрнуты в recover с уведомлением администратора
- **Retry для сообщений** — 2 попытки отправки с уведомлением админа при неудаче (включая curl-команду для отладки)
- **Pure Go SQLite** — используется `modernc.org/sqlite` без CGO, что позволяет собирать через ko.build

## Структура проекта

```
├── cmd/bot/main.go           # Точка входа
├── internal/
│   ├── db/                   # Репозитории и работа с БД
│   │   ├── queue.go          # Single-writer DB Queue
│   │   ├── schema.go         # Схема БД и миграции
│   │   ├── user_repository.go
│   │   ├── step_repository.go
│   │   ├── progress_repository.go
│   │   ├── answer_repository.go
│   │   ├── settings_repository.go
│   │   ├── chat_state_repository.go
│   │   ├── admin_state_repository.go
│   │   └── admin_messages_repository.go
│   ├── fsm/                  # FSM состояния
│   │   └── states.go
│   ├── handlers/             # Обработчики Telegram updates
│   │   ├── handler.go        # Основной обработчик
│   │   └── admin_handler.go  # Админ-интерфейс
│   ├── models/               # Модели данных
│   │   ├── user.go
│   │   ├── step.go
│   │   ├── progress.go
│   │   ├── answer.go
│   │   ├── settings.go
│   │   ├── chat_state.go
│   │   ├── admin_state.go
│   │   └── types.go
│   └── services/             # Бизнес-логика
│       ├── state_resolver.go # Определение текущего состояния
│       ├── answer_checker.go # Проверка ответов
│       ├── message_manager.go# Управление сообщениями
│       ├── error_manager.go  # Обработка ошибок
│       └── statistics.go     # Статистика прохождения
├── Dockerfile
├── docker-compose.yml
├── Makefile
└── .ko.yaml                  # Конфигурация ko.build
```

## Установка и запуск

### Требования
- Go 1.25+
- Docker и Docker Compose (для контейнеризации)
- Telegram Bot Token (получить у [@BotFather](https://t.me/BotFather))

### Локальный запуск

```bash
# Клонировать репозиторий
git clone https://github.com/ad/go-telegram-quest.git
cd go-telegram-quest

# Создать .env файл
cp .env.example .env
# Отредактировать .env, указав BOT_TOKEN и ADMIN_ID

# Запустить
go run ./cmd/bot
```

### Docker

```bash
# Создать .env файл
cp .env.example .env
# Отредактировать .env

# Собрать и запустить
docker compose up -d

# Посмотреть логи
docker compose logs -f

# Остановить
docker compose down
```

### Makefile команды

```bash
make build      # Собрать Docker образ
make up         # Запустить через docker compose
make down       # Остановить
make run        # Запустить локально (go run)
make test       # Запустить тесты
make build-ko   # Собрать через ko (локально)
make push       # Собрать и запушить через ko
make clean      # Удалить локальную БД
```

## Конфигурация

Переменные окружения:

| Переменная | Описание | По умолчанию |
|------------|----------|--------------|
| `BOT_TOKEN` | Токен Telegram бота | обязательно |
| `ADMIN_ID` | Telegram ID администратора | обязательно |
| `DB_PATH` | Путь к файлу SQLite | `quest.db` |

## Использование

### Команды для участников
- `/start` — начать квест или продолжить с текущего шага

### Команды для администратора
- `/admin` — открыть админ-панель
- `/cancel` — отменить текущую операцию

### Админ-панель
- **Добавить шаг** — создание нового шага с текстом, типом ответа (текст/фото), изображениями и вариантами ответов
- **Список шагов** — просмотр и редактирование существующих шагов
- **Настройки** — редактирование системных сообщений

### Типы шагов
1. **Текстовый с автопроверкой** — бот автоматически проверяет ответ по списку вариантов (case-insensitive)
2. **Текстовый с ручной проверкой** — ответ отправляется админу для проверки
3. **Фото** — участник отправляет фото, админ проверяет вручную

## База данных

SQLite с WAL режимом для лучшей производительности. Схема создаётся автоматически при первом запуске.

### Таблицы
- `users` — участники квеста
- `steps` — шаги квеста
- `step_images` — изображения шагов
- `step_answers` — варианты правильных ответов (lowercase)
- `user_progress` — прогресс участников
- `user_answers` — ответы участников
- `answer_images` — изображения в ответах
- `user_chat_state` — состояние чата (ID последних сообщений)
- `admin_state` — состояние админ-интерфейса
- `admin_messages` — служебные сообщения (статистика)
- `settings` — настройки бота

## Тестирование

Проект использует property-based тестирование с библиотекой [rapid](https://github.com/flyingmutant/rapid).

```bash
# Запустить все тесты
make test

# Запустить с verbose
go test -v ./...
```

## CI/CD с ko.build

Для production-сборки используется [ko](https://ko.build/) — инструмент для сборки Go-приложений в OCI-образы без Dockerfile.

```bash
# Установить ko
go install github.com/google/ko@latest

# Собрать локально
ko build --local ./cmd/bot

# Собрать и запушить в registry
export KO_DOCKER_REPO=ghcr.io/your-username
ko build ./cmd/bot
```

## Лицензия

MIT
